<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"/>
		
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>
			Verviers Running
		</title>
		<script src ="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.3/Control.FullScreen.css">
        <link rel="stylesheet" href="lib/leaflet/Leaflet.Coordinates-0.1.5.css"/>
		<style type="text/css">
			#map { height : 800px; }
			.legend { text-align: left; line-height: 18px; color: #555; } 
			.legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
			.hexbin-hexagon {
				stroke: #000;
				stroke-width: .5px;
			}
		</style>
	</head>
	<body>
		
		<div id="map"></div>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.4.3/Control.FullScreen.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.13.3/math.min.js"></script>
        <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
		<script src="https://d3js.org/d3-hexbin.v0.2.min.js"></script>
		<script src="https://rawgit.com/Asymmetrik/leaflet-d3/master/dist/leaflet-d3.js" charset="utf-8"></script>
        <script type="text/javascript" src="lib/leaflet/Leaflet.Coordinates-0.1.5.min.js"></script>
   		<script src="data/Verviers/movesAll.js"></script>
   		
		<script>
							
			var map = L.map('map', {
				fullscreenControl: true,
				}).setView([50.555,5.934], 13);
			
			var OpenStreetMap_Mapnik = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			});
			
			var CartoDB = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
				maxZoom: 18, 
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
			  });
			
			var CartoDB_DarkMatter = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
				subdomains: 'abcd',
				maxZoom: 19
			});
			
			var Stamen_Terrain = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
				attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
				subdomains: 'abcd',
				minZoom: 0,
				maxZoom: 18,
				ext: 'png'
			});

			var baseMaps = {
				"CartoDB": CartoDB,
				"CartoDB Dark": CartoDB_DarkMatter,
				"OpenStreetMap": OpenStreetMap_Mapnik,
				"Stamen_Terrain": Stamen_Terrain
			};
			
			map.addLayer(CartoDB)
			
			L.control.coordinates({
				position:"bottomleft",
				decimals:3,
				decimalSeperator:".",
				labelTemplateLat:"Lat: {y}",
				labelTemplateLng:"Lon: {x}"
			}).addTo(map);
			
			var heatStyle = {
				gradient : {.65: "white", .75:"#FFFF36", .85:"#FF9D00", .9:"#FF1700", .95:"#900000", 1:"black"},
				minOpacity: 0.25,
                radius: 5,
                blur: 5,
			};
			
			latlon = [];
			lonlat = []; // Try something more clever, please	

			
			function randomColor() {
				cc = '#'+Math.floor(Math.random()*16777215).toString(16);
				//console.log(cc)
				return(cc);
			}
			
			var customLayer = L.geoJson(null, {
				style: function(feature) {
					return { 
						color: randomColor(),
						weight: 4, 
						opacity: 1
						};
				},
				onEachFeature: function(feature) {
					coords = feature.geometry.coordinates;
					for ( var i=0; i < coords.length; ++i ){ 
						latlon.push([coords[i][1], coords[i][0]]);
						lonlat.push([coords[i][0], coords[i][1]]);
						}
					}
			});
			
			
			var customLayerLast = L.geoJson(null, {
				style: function(feature) {
					return { 
						color: 'black', 
						weight: 5, 
						opacity: 1
						};
				} 
			});
		
			var nMoves = moves.length;
			var OldTracks = []; 
			for (var i = 0; i < nMoves; i++) {
				var moveGps = omnivore.gpx('data/Verviers/' + moves[i], null, customLayer);
				if (i < nMoves - 1){
					OldTracks.push(moveGps);
				}
			}
			
			var moveGps = omnivore.gpx('data/Verviers/' + moves[nMoves-1], null, customLayerLast);
			moveGps.addTo(map);	
				
			var heatmap = L.heatLayer(latlon, heatStyle);
			heatlayer = L.layerGroup(heatmap);
			
			var hexoptions = {
				radius : 13,
				opacity: 0.5,
				duration: 200,
				colorScaleExtent: [ 1, 400 ],
				radiusScaleExtent: [ 1, undefined ],
				colorRange: [ '#FAFF69', '#F43C1D' ],
				colorValue: function(d) { return Math.log(d.length); },
				radiusRange: [ 5, 12 ],
			};

			var hexLayer = L.hexbinLayer(hexoptions);
			hexLayer.data(lonlat);
						
			var overlayers = {
				"Heat map": heatmap,
				"Hexbin": hexLayer,
				"Old tracks": L.layerGroup(OldTracks),
				"Last run": moveGps
			};
			
			L.control.layers(baseMaps, overlayers, {autoZIndex:false, collapsed:false}).addTo(map);	
			
		</script>
		
	</body>
</html>

